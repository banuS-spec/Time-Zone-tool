<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Time Zone Converter</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: #eafbea;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 520px;
      margin: 28px auto;
      background: #fff;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    h2 { text-align:center; color:#2e7d32; margin-top:0; }
    label { display:block; margin-top:10px; margin-bottom:6px; color:#388e3c; font-weight:700; }
    input, select, button {
      width:100%;
      padding:10px;
      margin-bottom:12px;
      border-radius:8px;
      border:1px solid #a5d6a7;
      font-size:15px;
      box-sizing:border-box;
    }
    button { cursor:pointer; background:#4CAF50; color:#fff; border:none; font-weight:700; }
    button:hover { background:#45a049; }
    .swap-button { background:#007BFF; }
    .swap-button:hover { background:#0069d9; }
    .result { margin-top:12px; font-size:16px; font-weight:700; color:#1b5e20; min-height:48px; }
    .world-clock { margin-top:16px; padding-top:12px; border-top:1px solid #a5d6a7; }
    .clock { display:flex; justify-content:space-between; padding:6px 0; }
    @media (max-width:600px) {
      .container { margin:14px; padding:16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Advanced Time Zone Converter</h2>

    <div id="currentTimeFromZone"></div>

    <label for="date">Select Date</label>
    <input id="date" type="date" />

    <label for="time">Select Time</label>
    <input id="time" type="time" />

    <label for="from">From Time Zone / City</label>
    <select id="from"></select>

    <label for="to">To Time Zone / City</label>
    <select id="to"></select>

    <button id="swapButton" class="swap-button">Swap Time Zones</button>

    <div class="result" id="result"></div>

    <div class="world-clock" id="worldClock">
      <h3>World Clock</h3>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const API_KEY = "RKUS3G225UPZ"; // (not used for the conversion core here)
    const cityMap = {
      "New York": "America/New_York",
      "Los Angeles": "America/Los_Angeles",
      "Chicago": "America/Chicago",
      "Toronto": "America/Toronto",
      "London": "Europe/London",
      "Paris": "Europe/Paris",
      "Berlin": "Europe/Berlin",
      "Rome": "Europe/Rome",
      "Milan": "Europe/Rome",
      "Tokyo": "Asia/Tokyo",
      "Dubai": "Asia/Dubai",
      "Colombo": "Asia/Colombo",
      "New Zealand": "Pacific/Auckland",
      "Sydney": "Australia/Sydney",
      "Hong Kong": "Asia/Hong_Kong",
      "Singapore": "Asia/Singapore",
      "India": "Asia/Kolkata"
    };

    const worldCities = [
      "America/New_York",
      "Europe/London",
      "Europe/Rome",
      "Asia/Colombo",
      "Australia/Sydney",
      "Asia/Tokyo"
    ];

    // ---- DOM refs ----
    const fromSelect = document.getElementById("from");
    const toSelect   = document.getElementById("to");
    const dateInput  = document.getElementById("date");
    const timeInput  = document.getElementById("time");
    const resultDiv  = document.getElementById("result");
    const swapButton = document.getElementById("swapButton");
    const worldClockDiv = document.getElementById("worldClock");
    const currentTimeFromZoneDiv = document.getElementById("currentTimeFromZone");

    // populate selects from cityMap
    function populateDropdowns() {
      // create a sorted list for nicer UX
      const entries = Object.entries(cityMap).sort((a,b) => a[0].localeCompare(b[0]));
      for (const [name, tz] of entries) {
        const opt1 = document.createElement("option");
        opt1.value = tz;
        opt1.textContent = name + " ‚Äî " + tz;
        fromSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = tz;
        opt2.textContent = name + " ‚Äî " + tz;
        toSelect.appendChild(opt2);
      }
    }

    // ---- Robust offset function using formatToParts ----
    // returns offset in minutes such that: localTimeUtcMs = instantMs + offsetMinutes*60000
    // i.e. offsetMinutes = (Date.UTC(localParts) - instantMs)/60000
    function getOffsetMinutesAt(instant, timeZone) {
      // instant can be Date or number
      const d = (instant instanceof Date) ? instant : new Date(instant);
      const dtf = new Intl.DateTimeFormat('en-US', {
        timeZone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
      const parts = dtf.formatToParts(d);
      let y, mo, da, hh, mm, ss;
      for (const p of parts) {
        if (p.type === 'year') y = Number(p.value);
        if (p.type === 'month') mo = Number(p.value);
        if (p.type === 'day') da = Number(p.value);
        if (p.type === 'hour') hh = Number(p.value);
        if (p.type === 'minute') mm = Number(p.value);
        if (p.type === 'second') ss = Number(p.value);
      }
      // local time interpreted as UTC ms:
      const localAsUtcMs = Date.UTC(y, mo - 1, da, hh, mm, ss || 0);
      const offsetMinutes = Math.round((localAsUtcMs - d.getTime()) / 60000);
      return offsetMinutes;
    }

    // Convert wall clock (dateStr YYYY-MM-DD, timeStr HH:MM) in fromZone -> real instant (Date)
    // iterate to resolve DST edge cases
    function wallTimeToInstant(dateStr, timeStr, fromZone) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const [hh, mm] = timeStr.split(':').map(Number);

      // initial guess: interpret the wall time as if it were UTC
      let instantMs = Date.UTC(y, m - 1, d, hh, mm);
      for (let i = 0; i < 6; i++) { // iterate a few times to converge
        const offsetMin = getOffsetMinutesAt(instantMs, fromZone);
        const nextInstantMs = Date.UTC(y, m - 1, d, hh, mm) - offsetMin * 60000;
        if (Math.abs(nextInstantMs - instantMs) < 500) {
          instantMs = nextInstantMs;
          break;
        }
        instantMs = nextInstantMs;
      }
      return new Date(instantMs);
    }

    // ---- Fixed conversion (uses above helpers) ----
    function convertTime() {
      const fromZone = fromSelect.value;
      const toZone = toSelect.value;
      const dateValue = dateInput.value;
      const timeValue = timeInput.value;

      if (!fromZone || !toZone || !dateValue || !timeValue) {
        resultDiv.innerHTML = "Please select a date, time, and both time zones.";
        return;
      }

      try {
        // compute the UTC instant corresponding to the wall time in the FROM zone
        const instant = wallTimeToInstant(dateValue, timeValue, fromZone);

        // format that instant in the TO zone
        const targetOptions = {
          timeZone: toZone,
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric"
        };
        const targetTime = instant.toLocaleString("en-US", targetOptions);

        // offsets at that instant
        const fromOffset = getOffsetMinutesAt(instant, fromZone);
        const toOffset   = getOffsetMinutesAt(instant, toZone);
        const diffHours  = (toOffset - fromOffset) / 60;
        const diffText   = (diffHours > 0 ? `+${diffHours.toFixed(1)}` : diffHours.toFixed(1)) + " hrs";

        // day/night in target zone
        const targetHourStr = new Intl.DateTimeFormat("en-US", { timeZone: toZone, hour12: false, hour: "numeric" }).format(instant);
        const targetHour = parseInt(targetHourStr, 10);
        const dayNight = (targetHour >= 6 && targetHour < 18) ? "Day üåû" : "Night üåú";

        resultDiv.innerHTML = `‚è∞ <b>${targetTime}</b> in <b>${toZone}</b> (${dayNight})<br>Time Difference: ${diffText}`;
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "‚ùå Conversion error. Please check the time zones and inputs.";
      }
    }

    // show current time in selected FROM zone
    function updateCurrentFromTime() {
      const fromZone = fromSelect.value;
      if (!fromZone) { currentTimeFromZoneDiv.innerHTML = ""; return; }
      const now = new Date();
      const options = {
        timeZone: fromZone,
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        weekday: "short", year: "numeric", month: "short", day: "numeric",
        hour12: false
      };
      const currentTime = now.toLocaleString("en-US", options);
      currentTimeFromZoneDiv.innerHTML = `<p>Current time in <b>${fromZone}</b>: <b>${currentTime}</b></p>`;
    }

    // world clock display
    function updateWorldClock() {
      worldClockDiv.innerHTML = "<h3>World Clock</h3>";
      const now = new Date();
      for (const city of worldCities) {
        try {
          const cityTime = now.toLocaleTimeString("en-US", { timeZone: city, hour: "2-digit", minute: "2-digit", hour12: true });
          const hourStr = new Intl.DateTimeFormat("en-US", { timeZone: city, hour: "numeric", hour12: false }).format(now);
          const hour = parseInt(hourStr, 10);
          const dayNight = (hour >= 6 && hour < 18) ? "Day üåû" : "Night üåú";
          const div = document.createElement("div");
          div.className = "clock";
          div.innerHTML = `<span>${city}</span><span>${cityTime} (${dayNight})</span>`;
          worldClockDiv.appendChild(div);
        } catch (e) {
          console.error("worldClock error for", city, e);
        }
      }
    }

    function swapTimeZones() {
      const a = fromSelect.value;
      const b = toSelect.value;
      fromSelect.value = b;
      toSelect.value = a;
      convertTime();
      updateCurrentFromTime();
    }

    // debounce helper
    let debounceTimer;
    function debounceConvert() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => convertTime(), 300);
    }

    // ---- Init ----
    window.onload = () => {
      populateDropdowns();
      // set user's timezone if available in cityMap, otherwise set the first option
      const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const found = Object.values(cityMap).includes(userTz);
      if (found) {
        fromSelect.value = userTz;
      } else if (fromSelect.options.length) {
        fromSelect.selectedIndex = 0;
      }
      toSelect.selectedIndex = fromSelect.selectedIndex === 0 ? 1 : 0;

      // set date/time defaults (date= today, time = now HH:MM 24h)
      dateInput.valueAsDate = new Date();
      timeInput.value = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

      // listeners
      fromSelect.addEventListener('change', () => { convertTime(); updateCurrentFromTime(); });
      toSelect.addEventListener('change', convertTime);
      dateInput.addEventListener('input', debounceConvert);
      timeInput.addEventListener('input', debounceConvert);
      swapButton.addEventListener('click', swapTimeZones);

      // world clock + current-from updates
      updateWorldClock();
      setInterval(updateWorldClock, 1000);
      updateCurrentFromTime();
      setInterval(updateCurrentFromTime, 1000);

      // initial conversion
      convertTime();
    };
  </script>
</body>
</html>
